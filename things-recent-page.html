<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../paper-item/paper-item.html">

<!--
`<things-recent-page>` Things Recent Page
  Example
    
    <things-recent-page></things-recent-page>

@demo demo/demo-things-recent-page.html
-->
<dom-module id="things-recent-page">
  <template>
    <div>
      <template is="dom-repeat" items="[[recentPages]]">    
        <paper-item>
          <li>
            <paper-item-body on-tap="routing">[[item.pageName]]</paper-item-body>
            <paper-icon-button icon="icons:clear" on-tap="deletePage"></paper-icon-button>
          </li>
        </paper-item>
      </template>
    </div>

    <iron-localstorage
      id="local-storage"
      name="recentPages"
      value="{{recentPages}}">
    </iron-localstorage>
  </template>

  <script>
    Polymer({
      is: 'things-recent-page',

      properties: {

        /**
         * local storage에 저장되는 최근 방문 페이지의 
         * pageName과 routeInfo
         */
        recentPages: {
          type: Object
        },

        /**
         * local storage의 저장 가능한 목록수
         */
        maxCount: {
          type: Number,
          value: 10
        }
      },

      /**
       * page 전환시 발생하는 event Listener
       */
      attached: function() {
        document.addEventListener('things-recent-page-add', function(event) {
          var request = event.detail;
          this.addPage(request.pageName, request.routeInfo);
        }.bind(this));
      },

      /**
       * 새로 추가된 pageName, routeInfo를 첫번째 index에 추가하고 index값이 maxCount를 넘어서는 것은 삭제 
       */
      addPage: function(pageName, routeInfo) {
        var newItem = {};
        newItem.pageName = pageName;
        newItem.routeInfo = routeInfo;

        if(!this.recentPages) {
          this.recentPages = [];
        }
        this.unshift('recentPages', newItem);

        while(this.recentPages.length > this.maxCount) {
          this.splice('recentPages', -1, 1);
        }
      },

      /**
       * 삭제 버튼 클릭시 실행되며 해당 item의 index를 통해 local storage에서 삭제
       */
      deletePage: function(event) {
        var idx = event.model.index;
        this.splice('recentPages', idx, 1);
      },

      /**
       * 화면에 출력된 pageName 클릭시 해당 페이지로 이동
       */
      routing: function(event) {
        var item = event.model.item;

        page('/' + item.routeInfo);
      }   
    });
  </script>
</dom-module>